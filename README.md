# Cogment Trial Datastore

[![Latest Release](https://img.shields.io/docker/v/cogment/trial-datastore?label=docker%20release&sort=semver&style=flat-square)](https://hub.docker.com/r/cogment/trial-datastore) [![Apache 2 License](https://img.shields.io/badge/license-Apache%202-green?style=flat-square)](./LICENSE) [![Changelog](https://img.shields.io/badge/-Changelog%20-blueviolet?style=flat-square)](./CHANGELOG.md)

[Cogment](https://cogment.ai) is an innovative open source AI platform designed to leverage the advent of AI to benefit humankind through human-AI collaboration developed by [AI Redefined](https://ai-r.com). Cogment enables AI researchers and engineers to build, train and operate AI agents in simulated or real environments shared with humans. For the full user documentation visit <https://docs.cogment.ai>

This module, Cogment Trial Datastore, is a intermediate storage dedicated to the logging of data generated by trials run with Cogment. It can either use an in-memory storage (the default) or a file-based storage.

## Usage

```console
$ docker run -p 9000:9000 cogment/trial-datastore
```

### Configuration

The following environment variables can be used to configure the server:

- `COGMENT_TRIAL_DATASTORE_PORT`: The port to listen on. Defaults to 9000.
- `COGMENT_TRIAL_DATASTORE_LOG_LEVEL`: minimum level for the logger ("trace", "debug", "info", "warn", "error"), defaults to "info".
- `COGMENT_TRIAL_DATASTORE_GRPC_REFLECTION`: Set to start a [gRPC reflection server](https://github.com/grpc/grpc/blob/master/doc/server-reflection.md). Defaults to `false`.
- `COGMENT_TRIAL_DATASTORE_MEMORY_STORAGE_MAX_SAMPLE_SIZE`: maximum cumulated size of samples size (in bytes) the memory storage holds before evicting least recently used trials samples. Defaults to 1GB.
- `COGMENT_TRIAL_DATASTORE_FILE_STORAGE_PATH`: if set, the datastore uses a file-based storage instead of the default in-memory one with the provided file path as its location.

## API

The Trial Datastore exposes a two gRPC APIs:

- the [datalog](https://github.com/cogment/cogment-api/blob/main/datalog.proto) API that used by the [Cogment Orchestrator](https://github.com/cogment/cogment-orchestrator) to forward all data generated by running trials.
- the [trial datastore](https://github.com/cogment/cogment-api/blob/main/trial_datastore.proto) API that is used to retrieve the data of a particular trial.

## Developers

### With a local Go installation

Linting is based on the "meta" linter [golangci-lint](https://golangci-lint.run) it needs to be installed locally:

```console
$ make lint
```

Testing:

```console
$ make test
```

Testing with JUnit style reports (for the CI):

```console
$ make test-with-report
```

Build a binary in `build/cogment-trial-datastore`:

```console
$ make build
```

High level benchmarks of the different backends can be launched with:

```console
$ make benchmark
```

### With Docker

Build image

```
$ ./scripts/build_docker.sh
```

### Release process

People having maintainers rights of the repository can follow these steps to release a version **MAJOR.MINOR.PATCH**. The versioning scheme follows [Semantic Versioning](http://semver.org/spec/v2.0.0.html).

1. Run `./scripts/create_release_branch.sh` automatically compute and update the version of the package, create the release branch and update the changelog from the commit history,
2. On the release branch, check and update the changelog if needed
3. Update `.cogment-api.yaml` (in particular make sure it doesn't rely on the _"latest"_ version)
4. Make sure everything's fine on CI,
5. Run `./scripts/tag_release.sh MAJOR.MINOR.PATCH` to create the specific version section in the changelog, merge the release branch in `main`, create the release tag and update the `develop` branch with those.

The rest, publishing the packages to github releases and dockerhub and updating the mirror repositories, is handled directly by the CI.
