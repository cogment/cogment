# 2021-02-17 cogment-cli

## `cogment-cli`

In its current form, `cogment-cli` is a single distributable written in
golang.

### Current

- Build output is single executable
- Build output targets multiple platforms (Windows, Linux, macOS)
- Runs offline, without an internet connection
- `init` subcommand scaffolds a "cogment app"
- `generate` subcommand runs `protoc`, outputting python and js

### Next

- [x] Build output is single executable
- [X] ~~Build output targets multiple platforms (Windows, Linux,
  macOS)~~ as a side effect of a local node.js distribution being
  available
- [X] ~~Runs offline, without an internet connection~~ if `npm install`
  has been run
- [x] `init` subcommand scaffolds a "cogment app"
- [x] `generate` subcommand runs `protoc`, outputting python and js
- [X] Build expects a local node distribution available on `$PATH`

#### cogment-init

Note: See [discussion](#discussion).

The reader now asks the user if they want to generate a web client,
and if so, do they want to generate a typescript web client.

Instead of templating a react-app, golang code executes various node.js
commands: `npm`, `npx`, `node` is used in third party module scripts.
This makes an internet connection a requirement of generating a
web-client.

Now requires a node distribution to be available. This is worked around
and has additional benefits (such as the inclusion of `protoc` in the
executable). Considering a user needs to run `npm install`, being online
a requirement of `init` seems reasonable.

### `cogment-init`

It is possible to use [pkg](https://www.npmjs.com/package/pkg) to build
an executable for each platform that outputs the entire node application
as a single executable, one for each platform (Windows, Linux and
macOs). It does this by downloading the correct node distribution for
each platform.

### `cogment generate`

Added a `--web-client` switch, adds `--js_out=web-client/src` to the
`protoc` command, javascript will not be generated without it.

Added a `--typescript` switch, adds
`--plugin=protoc-gen-ts=./web-client/node_modules/.bin/protoc-gen-ts
--ts_out=service=grpc-web:./web-client/src` to the `protoc` command.
Typescript (and the required local node_modules) is not required unless
this switch is activated

## Discussion

### web-client

This meeting is to discuss how the cogment-cli project should handle
management of the web-client.

The current implementation templates the files generated by `npm init
react-app`, minus the `node_modules`. This means `cogment init` will
generate a web-client that does not work OOB - `npm install` is required
to pull in dependencies.

Does this make having an internet connection a reasonable proposal?

Proposals that tackle some issues with the [next](#next) implementation.

#### go templates

Maintain with the current process of templating.

##### Advantages:

see [current](#current).

##### Disadvantages

Harder to maintain, templates go stale fast as improvements are made to
internal applications. This has been proven in death-match. There were
refactors made by me (Emma) that were implemented in cogment-cli, but
being unfamiliar with the project and golang in itself, did not have
time to focus on getting the merge request through.

Maintenance of a javascript project is easier using javascript tools.

#### running external `node` commands

This has been implemented in
[cogment-cli!41](https://gitlab.com/ai-r/cogment-cli/-/merge_requests/41).

##### Advantages

Instead of maintaining a javascript application in go templates, uses
`node`, `npm`, and `npx` to create a web-client using tools. This
ensures `init` generates a modern javascript project by using the same
tools used to generate the files that are converted into go templates.
This ensures `init` generates an up-to-date web-client. This is
important in javascript land, where the further out of date the project
dependencies get, the sooner and harder it becomes to update them, or
use a new package.

##### Disadvantages

Requires a node distribution is available.

I have tested the [pkg](https://www.npmjs.com/package/pkg) module. It
downloads the platform specific node.js distribution and packages it
into a single executable, along with node_modules and other potential
executables (think `protoc`).

This would package the output of the cogment-cli golang code along with
`protoc`, `node`, `npm`, `npx`.

Example output:

```commandline
ls cogment-cli-*
cogment-cli-linux  cogment-cli-macos  cogment-cli-win.exe
```

### using node

node.js itself supports
[template repositories](https://docs.npmjs.com/cli/v7/commands/npm-init)
for this purpose.

Publishing an npm package `@cogment/create-react-app` allows running the
command `npm init @cogment/react-app`.

Instead of managing a web-client ourselves, we can provide documentation
on how to create a `web-client` (or write golang code to do this, see
[previous](#running-external-node-commands) option).

This is easiest to maintain:

- Requires less golang code (if any at all)
- Maintaining a base `cogment-app` web-client as a repository itself
  removes a layer (or two) of indirection
  ade to
  internal applications. This has been proven in death-match. There were
  refactors made by me (Emma) that were implemented in cogment-cli, but
  being unfamiliar with the project and golang in itself, did not have
  time to focus on getting the merge request through.

Maintenance of a javascript project is easier using javascript tools.

#### running external `node` commands

This has been implemented in
[cogment-cli!41](https://gitlab.com/ai-r/cogment-cli/-/merge_requests/41).

##### Advantages

Instead of maintaining a javascript application in go templates, uses
`node`, `npm`, and `npx` to create a web-client using tools. This
ensures `init` generates a modern javascript project by using the same
tools used to generate the files that are converted into go templates.
This ensures `init` generates an up-to-date web-client. This is
important in javascript land, where the further out of date the project
dependencies get, the sooner and harder it becomes to update them, or
use a new package.

##### Disadvantages

Requires a node distribution is available.

I have tested the [pkg](https://www.npmjs.com/package/pkg) module. It
downloads the platform specific node.js distribution and packages it
into a single executable, along with node_modules and other potential
executables (think `protoc`).

This would package the output of the cogment-cli golang code along with
`protoc`, `node`, `npm`, `npx`.

Example output:

```commandline
ls cogment-cli-*
cogment-cli-linux  cogment-cli-macos  cogment-cli-win.exe
```

#### using node

node.js itself supports
[template repositories](https://docs.npmjs.com/cli/v7/commands/npm-init)
for this purpose.

Publishing an npm package `@cogment/create-react-app` allows running the
command `npm init @cogment/react-app`.

Instead of managing a web-client ourselves, we can provide documentation
on how to create a `web-client` (or write golang code to do this, see
[previous](#running-external-node-commands) option).

This is easiest to maintain:

- Requires less golang code (if any at all)
- Maintaining a base `cogment-app` web-client as a repository itself
  removes a layer (or two) of indirection
